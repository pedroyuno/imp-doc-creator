{% extends "base.html" %}

{% block title %}Generate Test Cases - {{ super() }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header -->
        <div class="text-center mb-4">
            <h2 class="fw-bold text-dark mb-1">üìù Generate Test Case Document</h2>
            <p class="text-muted">Create merchant-facing test case documentation for implementation validation</p>
            <p class="text-muted"><strong>Source File:</strong> {{ filename }}</p>
        </div>

        <!-- Options Form -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üõ†Ô∏è Document Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('generate_test_cases') }}">
                    <div class="row">
                        <!-- Merchant Name -->
                        <div class="col-md-6 mb-3">
                            <label for="merchant_name" class="form-label">
                                <strong>Merchant Name</strong>
                                <span class="text-muted">(for document header)</span>
                            </label>
                            <input type="text" class="form-control" id="merchant_name" name="merchant_name" 
                                   value="Merchant" placeholder="Enter merchant name">
                        </div>

                        <!-- Language -->
                        <div class="col-md-6 mb-3">
                            <label for="language" class="form-label">
                                <strong>Language</strong>
                                <span class="text-muted">(for test case descriptions)</span>
                            </label>
                            <select class="form-select" id="language" name="language">
                                <option value="en" selected>English</option>
                                <option value="es">Espa√±ol (Spanish)</option>
                                <option value="pt">Portugu√™s (Portuguese)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Output Format -->
                        <div class="col-md-6 mb-3">
                            <label for="output_format" class="form-label">
                                <strong>Output Format</strong>
                                <span class="text-muted">(recommended: HTML for Google Docs)</span>
                            </label>
                            <select class="form-select" id="output_format" name="output_format">
                                <option value="html">HTML (Google Docs compatible)</option>
                                <option value="docx" selected>DOCX (Microsoft Word compatible)</option>
                                <option value="markdown">Markdown (for technical documentation)</option>
                            </select>
                        </div>
                        
                        <!-- Environment -->
                        <div class="col-md-6 mb-3">
                            <label for="environment" class="form-label">
                                <strong>Environment</strong>
                                <span class="text-muted">(test case filtering)</span>
                            </label>
                            <select class="form-select" id="environment" name="environment">
                                <option value="separated" selected>Separated Tables (Sandbox + Production)</option>
                                <option value="sandbox">Sandbox Only</option>
                                <option value="production">Production Only</option>
                            </select>
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="mb-4">
                        <label class="form-label"><strong>Document Options</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_metadata" 
                                   name="include_metadata" checked>
                            <label class="form-check-label" for="include_metadata">
                                Include document metadata and summary statistics
                            </label>
                        </div>
                    </div>

                    <!-- Active Rules Files Info -->
                    {% if session.get('selected_rules_files') %}
                    <div class="alert alert-success">
                        <h6 class="alert-heading">üìö Active Feature Rules Files (Will be merged):</h6>
                        <ul class="mb-0">
                            <li><strong>Default:</strong> <code>feature_rules.json</code> (always included)</li>
                            {% for rules_file in session.get('selected_rules_files', []) %}
                            <li><strong>Additional:</strong> <code>{{ rules_file }}</code></li>
                            {% endfor %}
                        </ul>
                        <p class="mb-0 mt-2"><small class="text-muted">
                            <i class="fas fa-info-circle"></i> All selected rules files are merged together. 
                            Features, test cases, and integration steps from all files will be included in the generated document.
                        </small></p>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">üìö Feature Rules Files:</h6>
                        <p class="mb-0">
                            <strong>Default:</strong> <code>feature_rules.json</code> will be used.
                            <br><small class="text-muted">
                                <i class="fas fa-info-circle"></i> To include additional rules files (e.g., APAC, EMEA), 
                                select them when uploading the CSV file.
                            </small>
                        </p>
                    </div>
                    {% endif %}

                    <!-- What will be included -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">üìã What will be included:</h6>
                        <ul class="mb-0">
                            <li><strong>Implemented Features Only:</strong> Test cases for features marked as TRUE, Implemented, or similar values</li>
                            <li><strong>Merged Rules:</strong> Features, test cases, and integration steps from all selected rules files</li>
                            <li><strong>Separated Tables:</strong> Creates separate tables for sandbox and production test cases</li>
                            <li><strong>Environment Filtering:</strong> Choose specific environment or get separated tables</li>
                            <li><strong>Organized by Provider:</strong> Test cases grouped by provider + payment method combinations</li>
                            <li><strong>Test Case Types:</strong> Happy path, unhappy path, and corner case scenarios</li>
                            <li><strong>Google Docs Compatible:</strong> HTML format can be imported directly into Google Docs with formatting</li>
                            <li><strong>Professional Layout:</strong> Styled document with proper headings, colors, and structure</li>
                            <li><strong>Multiple Formats:</strong> Choose between HTML (recommended), DOCX, or Markdown</li>
                        </ul>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            ‚Üê Back to Results
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="previewTestCases()">
                                üëÅÔ∏è Preview
                            </button>
                            <button type="submit" class="btn btn-success">
                                üì• Download Document
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Information Section -->
        <div class="mt-4">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6 class="card-title">üìñ About Test Case Generation</h6>
                    <p class="card-text text-muted">
                        This feature generates comprehensive test case documentation for merchants based on your 
                        implementation scope analysis. The document includes test scenarios for all implemented 
                        features and can be imported directly into Google Docs for merchant testing validation.
                    </p>
                    <p class="card-text text-muted mb-0">
                        <strong>Formats:</strong> HTML (Google Docs compatible), DOCX (Microsoft Word), or Markdown (.md) for technical docs<br>
                        <strong>Coverage:</strong> Only features marked as implemented (TRUE, Implemented, etc.)<br>
                        <strong>Languages:</strong> English, Spanish, and Portuguese supported<br>
                        <strong>Environments:</strong> Separated tables by default, or filter by specific environment<br>
                        <strong>Import:</strong> HTML files can be opened directly in Google Docs, DOCX files open in Microsoft Word/Google Docs
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function previewTestCases() {
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    // Build preview URL with parameters
    const params = new URLSearchParams();
    for (let [key, value] of formData.entries()) {
        if (key === 'include_metadata') {
            params.append(key, 'true');
        } else {
            params.append(key, value);
        }
    }
    
    // Handle unchecked checkbox
    if (!formData.has('include_metadata')) {
        params.append('include_metadata', 'false');
    }
    
    // Open preview in new tab
    window.open('{{ url_for("test_case_preview") }}?' + params.toString(), '_blank');
}

// Update button text based on format selection
document.addEventListener('DOMContentLoaded', function() {
    const formatSelect = document.getElementById('output_format');
    const submitButton = document.querySelector('button[type="submit"]');
    
    function updateButtonText() {
        const format = formatSelect.value;
        if (format === 'html') {
            submitButton.innerHTML = 'üì• Download HTML Document';
        } else if (format === 'docx') {
            submitButton.innerHTML = 'üì• Download DOCX Document';
        } else {
            submitButton.innerHTML = 'üì• Download Markdown Document';
        }
    }
    
    formatSelect.addEventListener('change', updateButtonText);
    updateButtonText(); // Set initial text
});

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const merchantName = document.getElementById('merchant_name');
    
    form.addEventListener('submit', function(e) {
        if (merchantName.value.trim() === '') {
            merchantName.value = 'Merchant';
        }
    });
});

// Environment selection helper text
document.addEventListener('DOMContentLoaded', function() {
    const environmentSelect = document.getElementById('environment');
    const infoList = document.querySelector('.alert-info ul');
    
    function updateEnvironmentInfo() {
        const environment = environmentSelect.value;
        const environmentItem = infoList.querySelector('li:nth-child(2)');
        
        switch (environment) {
            case 'sandbox':
                environmentItem.innerHTML = '<strong>Environment Filtering:</strong> Sandbox environment test cases only';
                break;
            case 'production':
                environmentItem.innerHTML = '<strong>Environment Filtering:</strong> Production environment test cases only';
                break;
            case 'separated':
            default:
                environmentItem.innerHTML = '<strong>Separated Tables:</strong> Creates separate tables for sandbox and production test cases';
        }
    }
    
    environmentSelect.addEventListener('change', updateEnvironmentInfo);
    updateEnvironmentInfo(); // Set initial text
});
</script>
{% endblock %} 